---
# from https://github.com/geerlingguy/ansible-collection-mac
# Note: Using native macOS APIs instead of dockutil for better compatibility.

- name: Set Dock settings
  community.general.osx_defaults: domain=com.apple.dock key={{ item.key }} type={{ item.type }} value={{ item.value }}
  loop:
    # Enable highlight hover effect for the grid view of a stack (Dock)
    - {key: "mouse-over-hilite-stack", type: "bool", value: "true"}
    # Set the icon size (px) of Dock items
    - {key: "tilesize", type: "float", value: "{{ dock_icon_size }}"}
    # Show indicator lights for open applications in the Dock
    - {key: "show-process-indicators", type: "bool", value: "true"}
    # Speed up Mission Control animations
    - {key: "expose-animation-duration", type: "float", value: "0.1"}
    # Donâ€™t show Dashboard as a Space
    - {key: "dashboard-in-overlay", type: "bool", value: "false"}
  notify:
    - Kill Dock
  tags: dock

- name: Get current dock persistent apps
  ansible.builtin.command: defaults read com.apple.dock persistent-apps
  register: dock_current_items
  changed_when: false
  failed_when: false
  tags: dock

- name: Build expected dock app names
  ansible.builtin.set_fact:
    dock_expected_apps: "{{ dock_items_persist | map(attribute='name') | list }}"
  tags: dock

- name: Check if dock needs updating
  ansible.builtin.set_fact:
    dock_needs_update: "{{ 'file-label' not in dock_current_items.stdout or 
                           dock_current_items.rc != 0 }}"
  tags: dock

- name: Reset and repopulate dock (only if needed)
  block:
    - name: Clear dock items
      ansible.builtin.command: defaults write com.apple.dock persistent-apps -array
      become: true
      become_user: jan

    - name: Add dock items
      ansible.builtin.command: >
        defaults write com.apple.dock persistent-apps -array-add
        "<dict><key>tile-data</key><dict><key>file-label</key><string>{{ item.name }}</string></dict><key>tile-type</key><string>file-tile</string></dict>"
      become: true
      become_user: jan
      loop: "{{ dock_items_persist }}"

    - name: Kill Dock to apply changes
      ansible.builtin.command: killall Dock
      become: true
  when: dock_needs_update
  tags: dock
