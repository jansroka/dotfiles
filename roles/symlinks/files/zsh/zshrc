#!/usr/bin/env zsh

# Launch GPG agent asynchronously to avoid blocking startup
(gpgconf --launch gpg-agent &)

autoload -Uz vcs_info
precmd() { vcs_info }

zstyle ':vcs_info:git:*' formats '%b '

setopt PROMPT_SUBST
PROMPT='%F{green}%*%f %F{blue}%~%f %F{red}${vcs_info_msg_0_}%f$ '

# heroku autocomplete setup
HEROKU_AC_ZSH_SETUP_PATH=/Users/jan/Library/Caches/heroku/autocomplete/zsh_setup && test -f $HEROKU_AC_ZSH_SETUP_PATH && source $HEROKU_AC_ZSH_SETUP_PATH;

# rbenv init
eval "$(rbenv init -)"

# NVM lazy initialization - defer until first use
export NVM_DIR="$HOME/.nvm"
_nvm_loaded=0

_init_nvm() {
  if [ $_nvm_loaded -eq 0 ]; then
    [ -s "$(brew --prefix)/opt/nvm/nvm.sh" ] && \. "$(brew --prefix)/opt/nvm/nvm.sh"
    [ -s "$(brew --prefix)/opt/nvm/etc/bash_completion.d/nvm" ] && \. "$(brew --prefix)/opt/nvm/etc/bash_completion.d/nvm"
    _nvm_loaded=1
  fi
}

# Override nvm command to initialize on first use
nvm() {
  _init_nvm
  command nvm "$@"
}

# Automatically use nvm when entering directories with .nvmrc
autoload -U add-zsh-hook
load-nvmrc() {
  # Only initialize NVM if entering a directory with .nvmrc
  if [ -f .nvmrc ]; then
    _init_nvm
    local node_version="$(nvm version)"
    local nvmrc_node_version=$(nvm version "$(cat .nvmrc)")
    
    if [ "$nvmrc_node_version" = "N/A" ]; then
      nvm install
    elif [ "$nvmrc_node_version" != "$node_version" ]; then
      nvm use
    fi
    hash -r
  fi
}
add-zsh-hook chpwd load-nvmrc

# Basic Memory alias - Use Python 3.13 to avoid Pydantic V1 warnings

# Basic Memory - Use Python 3.13 to avoid Pydantic warnings
bm() { uvx --python python3.13 basic-memory "$@"; }

# Source bash aliases for compatibility
[ -f ~/.bash_aliases ] && source ~/.bash_aliases

# Explicitly set PS1 to use colored PROMPT
PS1='%F{green}%*%f %F{blue}%~%f %F{red}${vcs_info_msg_0_}%f$ '
. "/Users/jan/.acme.sh/acme.sh.env"
